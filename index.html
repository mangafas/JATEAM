<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>ATM map BOC</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script>
        
        function degreesToRadians(degrees) {
          return degrees * Math.PI / 180;
        }
        
        function distanceInKmBetweenEarthCoordinates(lat1, lon1, lat2, lon2) {
          var earthRadiusKm = 6371;
        
          var dLat = degreesToRadians(lat2-lat1);
          var dLon = degreesToRadians(lon2-lon1);
        
          lat1 = degreesToRadians(lat1);
          lat2 = degreesToRadians(lat2);
        
          var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2); 
          var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
          return earthRadiusKm * c;
        }
		function initialize() {

		  var myLatlng = new google.maps.LatLng(35.1856,33.3823);
		  var mapOptions = {
		    zoom: 15,
		    center: myLatlng
		  };
		  var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
		  var  infoWindow = new google.maps.InfoWindow;
          var dist=100;
		  var positionL;
		  var curLat;
          var curLng;
		  if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function(position) {
                pos = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
                };
                positionL = pos;
                infoWindow.setPosition(pos);
                infoWindow.setContent('My Location !');
                infoWindow.open(map);
                map.setCenter(pos);
              }, function() {
                handleLocationError(true, infoWindow, map.getCenter());
              });
		  }

		  
		  /*if (navigator.geolocation) {
              console.log('Geolocation is supported!');
              var startPos;
              var geoSuccess = function(position) {
                startPos = position;
                console.log(startPos);
                
                var image = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';
                var markerLoc = new google.maps.Marker({
        			position: new google.maps.LatLng(startPos.coords.latitude,startPos.coords.longitude),
        			map: map,
        			icon: image,
        			animation: google.maps.Animation.DROP,
        			title: "My location"
        	    });
              };
              navigator.geolocation.getCurrentPosition(geoSuccess);
              
            }
            else {
                console.log('Geolocation is not supported for this Browser/OS.');
            }*/

		  var loc = window.location;
          if (loc.protocol === "https:") {
            newUri = "wss:";
          } else {
            newUri = "ws:";
          }
          newUri += "//" + loc.host + "/ws/locs";
		  // check for Geolocation support
		 

          

		  
		  var sock = new WebSocket(newUri);
		  sock.onopen = function(){ 
		    console.log("Connected websocket");
		    console.log("Sending ping..");
			sock.send("Ping!");
		    console.log("Ping sent..");
		  };
		  sock.onerror = function(){ console.log("Websocket error"); };
		  sock.onmessage = function(evt){
		    var stationData = JSON.parse(evt.data);
		    console.log(stationData.atms);
		    //var stations = stationData.root.stations[0].station;
			for(var i = 0; i < stationData.atms.length; i++) {
			 
			  var station = stationData.atms[i];
		
              var marker = new google.maps.Marker({
			    position: new google.maps.LatLng(station.location.latitude,station.location.longitude),
			    map: map,
			    animation: google.maps.Animation.DROP,
			    title: station.name
			  });
			  console.log(positionL);
			  console.log("currentDist : " +distanceInKmBetweenEarthCoordinates(positionL.lat, positionL.lng, station.location.latitude,station.location.longitude));
			  //console.log(pos.lat +","+ pos.lng +","+ station.location.latitude +","+ station.location.longitude);
              var dist2 = distanceInKmBetweenEarthCoordinates(positionL.lat, positionL.lng, station.location.latitude,station.location.longitude);
              
              if(dist > dist2){
                  dist = dist2;
                  curLat= station.location.latitude;
                  curLng = station.location.longitude;
              }
			  
			}
			console.log("distance: " +dist);
			console.log("coor: " +curLat +","+curLng);
			var coor = {
                  lat: curLat,
                  lng: curLng
                };
			var  infoWindowClose = new google.maps.InfoWindow;
            infoWindowClose.setPosition(coor);
            infoWindowClose.setContent('Closest ATM !');
            infoWindowClose.open(map);
            map.setCenter(coor);
			
		  };
		  
		};
		
		google.maps.event.addDomListener(window, 'load', initialize);
        
    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
  </body>
</html>
